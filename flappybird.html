<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Horror Flappy - Nightmare Flight</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background: linear-gradient(
          to bottom,
          #0a0a0a 0%,
          #1a0a1a 50%,
          #0a0a0a 100%
        );
        font-family: "Arial", sans-serif;
        overflow: hidden;
      }

      #gameContainer {
        position: relative;
        width: 400px;
        height: 600px;
        background: linear-gradient(
          to bottom,
          #0a0a0a 0%,
          #1a0a1a 75%,
          #0a0a0a 75%,
          #0a0a0a 100%
        );
        border: 4px solid #8b0000;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(139, 0, 0, 0.8), 0 0 20px rgba(139, 0, 0, 0.5);
      }

      #gameCanvas {
        display: block;
        width: 100%;
        height: 100%;
      }

      #startScreen,
      #gameOverScreen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: rgba(0, 0, 0, 0.9);
        color: #ff0000;
        z-index: 10;
        text-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000;
      }

      h1 {
        font-size: 48px;
        margin-bottom: 20px;
        color: #ff0000;
        text-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000, 0 0 30px #8b0000, 3px 3px 6px rgba(0, 0, 0, 0.8);
        animation: pulse 2s infinite;
      }
      
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
      }

      .btn {
        padding: 15px 40px;
        font-size: 20px;
        background: #8b0000;
        color: #ffffff;
        border: 2px solid #ff0000;
        border-radius: 10px;
        cursor: pointer;
        margin: 10px;
        transition: all 0.3s;
        box-shadow: 0 0 10px rgba(255, 0, 0, 0.5), 0 4px 6px rgba(0, 0, 0, 0.5);
        text-shadow: 0 0 5px #ff0000;
      }

      .btn:hover {
        background: #ff0000;
        transform: translateY(-2px);
        box-shadow: 0 0 20px rgba(255, 0, 0, 0.8), 0 6px 8px rgba(0, 0, 0, 0.6);
      }

      #score {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 48px;
        color: #ff0000;
        text-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000, 3px 3px 6px rgba(0, 0, 0, 0.8);
        z-index: 5;
        font-weight: bold;
      }

      #finalScore {
        font-size: 32px;
        margin: 20px 0;
        color: #ff0000;
        text-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000;
      }

      .hidden {
        display: none !important;
      }

      .instructions {
        font-size: 18px;
        margin-top: 20px;
        text-align: center;
        color: #ff6666;
        text-shadow: 0 0 5px #ff0000;
      }

      #customization {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.8);
        padding: 15px;
        border-radius: 8px;
        z-index: 20;
        color: white;
        max-width: 220px;
        font-size: 12px;
      }

      #customization h3 {
        font-size: 16px;
        margin-bottom: 10px;
        color: #ff0000;
        text-shadow: 0 0 5px #ff0000;
      }

      #customization input[type="file"] {
        margin: 5px 0;
        font-size: 11px;
        color: white;
        width: 100%;
      }

      #customization label {
        display: block;
        margin-top: 8px;
        font-size: 13px;
        font-weight: bold;
      }

      .small-btn {
        padding: 5px 10px;
        font-size: 12px;
        margin-top: 5px;
        width: 100%;
      }

      .sound-label {
        color: #ff6666;
      }

      .test-btn {
        background: #8b0000;
        padding: 3px 8px;
        font-size: 11px;
        margin-left: 5px;
        border: 1px solid #ff0000;
      }

      .test-btn:hover {
        background: #ff0000;
      }

      .sound-status {
        font-size: 10px;
        color: #ff6666;
        margin-left: 5px;
      }
    </style>
  </head>
  <body>
    <div style="display: flex; align-items: flex-start; gap: 20px">
      <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="score" class="hidden">0</div>

        <div id="startScreen">
          <h1>ü¶á NIGHTMARE FLIGHT</h1>
          <button class="btn" onclick="startGame()">Enter the Darkness</button>
          <div class="instructions">
            Press SPACE or Click to Fly!<br />
            ‚ö†Ô∏è Beware the Shadows... ‚ö†Ô∏è
          </div>
        </div>

        <div id="gameOverScreen" class="hidden">
          <h1>üíÄ YOU DIED</h1>
          <div id="finalScore">Souls Collected: 0</div>
          <button class="btn" onclick="restartGame()">Try Again</button>
        </div>
      </div>

      <!-- Customization box moved outside -->
      <div id="customization">
        <h3>üé® Customize</h3>

        <label>Bird Image:</label>
        <input type="file" id="birdImage" accept="image/*" />
        <button class="btn small-btn" onclick="resetBirdImage()">
          Reset Bird
        </button>

        <label class="sound-label">üéµ Sounds:</label>

        <label>Flap Sound: <span id="flapStatus"></span></label>
        <input type="file" id="flapSound" accept="audio/*" />
        <button class="btn small-btn test-btn" onclick="testFlapSound()">
          Test
        </button>

        <label>Score Sound: <span id="scoreStatus"></span></label>
        <input type="file" id="scoreSound" accept="audio/*" />
        <button class="btn small-btn test-btn" onclick="testScoreSound()">
          Test
        </button>

        <label>Game Over Sound: <span id="gameOverStatus"></span></label>
        <input type="file" id="gameOverSound" accept="audio/*" />
        <button class="btn small-btn test-btn" onclick="testGameOverSound()">
          Test
        </button>

        <button class="btn small-btn" onclick="resetAllSounds()">
          Reset All Sounds
        </button>
      </div>
    </div>

    <script>
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      canvas.width = 400;
      canvas.height = 600;

      let gameState = "start";
      let score = 0;
      let frames = 0;
      let customBirdImage = null;

      // Audio objects for custom sounds
      let customFlapSound = null;
      let customScoreSound = null;
      let customGameOverSound = null;

      const bird = {
        x: 80,
        y: 250,
        width: 40,
        height: 40,
        velocity: 0,
        gravity: 0.4,  // Reduced gravity for easier control
        jump: -10,  // Stronger jump
        rotation: 0,
      };

      const pipes = [];
      const pipeWidth = 52;
      const pipeGap = 200;  // Increased gap for easier gameplay
      const pipeSpeed = 1.5;  // Slower speed

      // Sound effects using Web Audio API (default sounds)
      const audioContext = new (window.AudioContext ||
        window.webkitAudioContext)();

      function playDefaultFlapSound() {
        // Spooky wing flap sound
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.type = 'sawtooth';
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.setValueAtTime(150, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(
          80,
          audioContext.currentTime + 0.15
        );

        gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(
          0.01,
          audioContext.currentTime + 0.15
        );

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.15);
      }

      function playDefaultScoreSound() {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.frequency.setValueAtTime(
          1000,
          audioContext.currentTime + 0.05
        );

        gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(
          0.01,
          audioContext.currentTime + 0.2
        );

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.2);
      }

      function playDefaultGameOverSound() {
        // Horror death sound - multiple oscillators for creepy effect
        const osc1 = audioContext.createOscillator();
        const osc2 = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        osc1.type = 'sawtooth';
        osc2.type = 'square';
        
        osc1.connect(gainNode);
        osc2.connect(gainNode);
        gainNode.connect(audioContext.destination);

        osc1.frequency.setValueAtTime(200, audioContext.currentTime);
        osc1.frequency.exponentialRampToValueAtTime(
          50,
          audioContext.currentTime + 0.8
        );
        
        osc2.frequency.setValueAtTime(150, audioContext.currentTime);
        osc2.frequency.exponentialRampToValueAtTime(
          40,
          audioContext.currentTime + 0.8
        );

        gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(
          0.01,
          audioContext.currentTime + 0.8
        );

        osc1.start(audioContext.currentTime);
        osc2.start(audioContext.currentTime);
        osc1.stop(audioContext.currentTime + 0.8);
        osc2.stop(audioContext.currentTime + 0.8);
      }

      // Custom sound players
      function playFlapSound() {
        if (customFlapSound) {
          customFlapSound.currentTime = 0;
          customFlapSound.play();
        } else {
          playDefaultFlapSound();
        }
      }

      function playScoreSound() {
        if (customScoreSound) {
          customScoreSound.currentTime = 0;
          customScoreSound.play();
        } else {
          playDefaultScoreSound();
        }
      }

      function playGameOverSound() {
        if (customGameOverSound) {
          customGameOverSound.currentTime = 0;
          customGameOverSound.play();
        } else {
          playDefaultGameOverSound();
        }
      }

      // Test sound functions
      function testFlapSound() {
        playFlapSound();
      }

      function testScoreSound() {
        playScoreSound();
      }

      function testGameOverSound() {
        playGameOverSound();
      }

      // Handle custom bird image upload
      document
        .getElementById("birdImage")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (event) {
              const img = new Image();
              img.onload = function () {
                customBirdImage = img;
              };
              img.src = event.target.result;
            };
            reader.readAsDataURL(file);
          }
        });

      // Handle flap sound upload
      document
        .getElementById("flapSound")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (event) {
              customFlapSound = new Audio(event.target.result);
              customFlapSound.volume = 0.5;
              document.getElementById("flapStatus").textContent = "‚úÖ";
              document.getElementById("flapStatus").className = "sound-status";
            };
            reader.readAsDataURL(file);
          }
        });

      // Handle score sound upload
      document
        .getElementById("scoreSound")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (event) {
              customScoreSound = new Audio(event.target.result);
              customScoreSound.volume = 0.5;
              document.getElementById("scoreStatus").textContent = "‚úÖ";
              document.getElementById("scoreStatus").className = "sound-status";
            };
            reader.readAsDataURL(file);
          }
        });

      // Handle game over sound upload
      document
        .getElementById("gameOverSound")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (event) {
              customGameOverSound = new Audio(event.target.result);
              customGameOverSound.volume = 0.5;
              document.getElementById("gameOverStatus").textContent = "‚úÖ";
              document.getElementById("gameOverStatus").className =
                "sound-status";
            };
            reader.readAsDataURL(file);
          }
        });

      function resetBirdImage() {
        customBirdImage = null;
        document.getElementById("birdImage").value = "";
      }

      function resetAllSounds() {
        customFlapSound = null;
        customScoreSound = null;
        customGameOverSound = null;
        document.getElementById("flapSound").value = "";
        document.getElementById("scoreSound").value = "";
        document.getElementById("gameOverSound").value = "";
        document.getElementById("flapStatus").textContent = "";
        document.getElementById("scoreStatus").textContent = "";
        document.getElementById("gameOverStatus").textContent = "";
      }

      function drawBird() {
        ctx.save();
        ctx.translate(bird.x + bird.width / 2, bird.y + bird.height / 2);
        ctx.rotate(bird.rotation);

        if (customBirdImage) {
          ctx.drawImage(
            customBirdImage,
            -bird.width / 2,
            -bird.height / 2,
            bird.width,
            bird.height
          );
        } else {
          // Draw an enhanced spooky bat/creature with better graphics
          ctx.save();
          
          // Body with gradient
          const bodyGradient = ctx.createRadialGradient(0, 0, 0, 0, 0, bird.width / 2);
          bodyGradient.addColorStop(0, "#2a1a2a");
          bodyGradient.addColorStop(0.7, "#1a0a1a");
          bodyGradient.addColorStop(1, "#0a0a0a");
          
          ctx.fillStyle = bodyGradient;
          ctx.beginPath();
          ctx.ellipse(0, 0, bird.width / 2, bird.height / 2, bird.rotation * 0.3, 0, Math.PI * 2);
          ctx.fill();
          
          // Body outline with glow
          ctx.strokeStyle = "#8b0000";
          ctx.lineWidth = 2;
          ctx.shadowBlur = 8;
          ctx.shadowColor = "#8b0000";
          ctx.stroke();
          
          // Enhanced wings with animation
          const wingFlap = Math.sin(frames * 0.3) * 0.2;
          ctx.fillStyle = "#0a0a0a";
          ctx.shadowBlur = 5;
          ctx.shadowColor = "#1a0a1a";
          
          // Left wing
          ctx.beginPath();
          ctx.ellipse(-bird.width / 2 - 8, 0, 10 + wingFlap * 3, bird.height / 2 + wingFlap * 2, -0.4 + wingFlap, 0, Math.PI * 2);
          ctx.fill();
          
          // Right wing
          ctx.beginPath();
          ctx.ellipse(bird.width / 2 + 8, 0, 10 + wingFlap * 3, bird.height / 2 + wingFlap * 2, 0.4 - wingFlap, 0, Math.PI * 2);
          ctx.fill();
          
          // Wing membrane details
          ctx.strokeStyle = "#1a0a1a";
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(-bird.width / 2 - 8, 0);
          ctx.lineTo(-bird.width / 2 - 15, -bird.height / 3);
          ctx.lineTo(-bird.width / 2 - 15, bird.height / 3);
          ctx.stroke();
          ctx.beginPath();
          ctx.moveTo(bird.width / 2 + 8, 0);
          ctx.lineTo(bird.width / 2 + 15, -bird.height / 3);
          ctx.lineTo(bird.width / 2 + 15, bird.height / 3);
          ctx.stroke();
          
          // Glowing red eyes with pulsing effect
          const eyePulse = Math.sin(frames * 0.2) * 0.3 + 0.7;
          ctx.fillStyle = "#ff0000";
          ctx.shadowBlur = 15 * eyePulse;
          ctx.shadowColor = "#ff0000";
          
          // Left eye
          ctx.beginPath();
          ctx.arc(-8, -5, 5 * eyePulse, 0, Math.PI * 2);
          ctx.fill();
          
          // Right eye
          ctx.beginPath();
          ctx.arc(8, -5, 5 * eyePulse, 0, Math.PI * 2);
          ctx.fill();
          
          // Eye pupils
          ctx.fillStyle = "#000000";
          ctx.shadowBlur = 0;
          ctx.beginPath();
          ctx.arc(-8, -5, 2, 0, Math.PI * 2);
          ctx.fill();
          ctx.beginPath();
          ctx.arc(8, -5, 2, 0, Math.PI * 2);
          ctx.fill();
          
          // Enhanced fangs
          ctx.fillStyle = "#ffffff";
          ctx.strokeStyle = "#cccccc";
          ctx.lineWidth = 1;
          
          // Left fang
          ctx.beginPath();
          ctx.moveTo(-3, 5);
          ctx.lineTo(-1, 12);
          ctx.lineTo(1, 5);
          ctx.closePath();
          ctx.fill();
          ctx.stroke();
          
          // Right fang
          ctx.beginPath();
          ctx.moveTo(3, 5);
          ctx.lineTo(1, 12);
          ctx.lineTo(-1, 5);
          ctx.closePath();
          ctx.fill();
          ctx.stroke();
          
          // Glow effect around creature
          ctx.strokeStyle = "#8b0000";
          ctx.lineWidth = 1;
          ctx.shadowBlur = 10;
          ctx.shadowColor = "#8b0000";
          ctx.beginPath();
          ctx.ellipse(0, 0, bird.width / 2 + 3, bird.height / 2 + 3, 0, 0, Math.PI * 2);
          ctx.stroke();
          
          ctx.restore();
        }

        ctx.restore();
      }

      function drawPipe(pipe) {
        // Draw creepy tentacles
        const time = frames * 0.05;
        
        // Top tentacle
        drawTentacle(pipe.x + pipeWidth / 2, 0, pipe.top, time, true);
        
        // Bottom tentacle
        drawTentacle(pipe.x + pipeWidth / 2, pipe.bottom, canvas.height - pipe.bottom, time, false);
        
        // Additional smaller tentacles for horror effect
        drawTentacle(pipe.x + pipeWidth / 4, 0, pipe.top * 0.8, time + 1, true);
        drawTentacle(pipe.x + pipeWidth * 3 / 4, 0, pipe.top * 0.8, time + 2, true);
        drawTentacle(pipe.x + pipeWidth / 4, pipe.bottom, (canvas.height - pipe.bottom) * 0.8, time + 1, false);
        drawTentacle(pipe.x + pipeWidth * 3 / 4, pipe.bottom, (canvas.height - pipe.bottom) * 0.8, time + 2, false);
      }
      
      function drawTentacle(startX, startY, length, time, isTop) {
        ctx.save();
        
        // Tentacle segments with organic movement
        const segments = Math.floor(length / 8);
        const points = [];
        
        for (let i = 0; i <= segments; i++) {
          const progress = i / segments;
          const y = isTop ? startY + length * progress : startY + length * progress;
          const wave = Math.sin(time + progress * 3) * (8 - progress * 4);
          const x = startX + wave;
          points.push({ x, y });
        }
        
        // Draw tentacle body with gradient
        ctx.beginPath();
        ctx.moveTo(points[0].x, points[0].y);
        
        for (let i = 1; i < points.length; i++) {
          const cp1x = points[i - 1].x + (points[i].x - points[i - 1].x) / 3;
          const cp1y = points[i - 1].y;
          const cp2x = points[i].x - (points[i].x - points[i - 1].x) / 3;
          const cp2y = points[i].y;
          ctx.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, points[i].x, points[i].y);
        }
        
        // Tentacle gradient
        const gradient = ctx.createLinearGradient(
          points[0].x, points[0].y,
          points[points.length - 1].x, points[points.length - 1].y
        );
        gradient.addColorStop(0, "#1a0a1a");
        gradient.addColorStop(0.5, "#2a0a2a");
        gradient.addColorStop(1, "#0a0a0a");
        
        ctx.strokeStyle = gradient;
        ctx.lineWidth = 12;
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
        ctx.shadowBlur = 15;
        ctx.shadowColor = "#8b0000";
        ctx.stroke();
        
        // Draw tentacle segments with texture
        for (let i = 0; i < points.length - 1; i++) {
          const progress = i / points.length;
          const radius = 6 - progress * 2;
          
          // Suckers on tentacle
          if (i % 3 === 0) {
            ctx.fillStyle = "#8b0000";
            ctx.shadowBlur = 8;
            ctx.shadowColor = "#ff0000";
            ctx.beginPath();
            ctx.arc(points[i].x, points[i].y, radius * 0.8, 0, Math.PI * 2);
            ctx.fill();
            
            // Sucker highlight
            ctx.fillStyle = "#ff0000";
            ctx.shadowBlur = 0;
            ctx.beginPath();
            ctx.arc(points[i].x - 1, points[i].y - 1, radius * 0.3, 0, Math.PI * 2);
            ctx.fill();
          }
          
          // Main tentacle body
          ctx.fillStyle = gradient;
          ctx.beginPath();
          ctx.arc(points[i].x, points[i].y, radius, 0, Math.PI * 2);
          ctx.fill();
        }
        
        // Tentacle tip with glow
        const tip = points[points.length - 1];
        ctx.fillStyle = "#ff0000";
        ctx.shadowBlur = 20;
        ctx.shadowColor = "#ff0000";
        ctx.beginPath();
        ctx.arc(tip.x, tip.y, 8, 0, Math.PI * 2);
        ctx.fill();
        
        // Tip spikes
        ctx.strokeStyle = "#ff0000";
        ctx.lineWidth = 2;
        for (let angle = 0; angle < Math.PI * 2; angle += Math.PI / 3) {
          ctx.beginPath();
          ctx.moveTo(tip.x, tip.y);
          ctx.lineTo(
            tip.x + Math.cos(angle) * 12,
            tip.y + Math.sin(angle) * 12
          );
          ctx.stroke();
        }
        
        ctx.restore();
      }

      function drawBackground() {
        // Dark night sky with deep purple/black gradient
        const skyGradient = ctx.createLinearGradient(0, 0, 0, 450);
        skyGradient.addColorStop(0, "#000000");
        skyGradient.addColorStop(0.3, "#1a0a1a");
        skyGradient.addColorStop(0.6, "#2a0a2a");
        skyGradient.addColorStop(1, "#0a0a0a");
        ctx.fillStyle = skyGradient;
        ctx.fillRect(0, 0, canvas.width, 450);

        // Dark ground with texture
        const groundGradient = ctx.createLinearGradient(0, 450, 0, 600);
        groundGradient.addColorStop(0, "#0a0a0a");
        groundGradient.addColorStop(1, "#000000");
        ctx.fillStyle = groundGradient;
        ctx.fillRect(0, 450, canvas.width, 150);
        
        // Creepy ground texture with cracks
        ctx.strokeStyle = "#1a0a0a";
        ctx.lineWidth = 1;
        for (let i = 0; i < canvas.width; i += 20) {
          ctx.beginPath();
          ctx.moveTo(i, 450);
          ctx.lineTo(i + Math.random() * 10 - 5, 460);
          ctx.stroke();
        }

        // Blood red moon with pulsing effect
        const moonX = 100 + (frames % 400) * 0.5;
        const moonY = 80;
        const pulse = Math.sin(frames * 0.05) * 3;
        
        // Moon outer glow
        ctx.fillStyle = "rgba(139, 0, 0, 0.2)";
        ctx.shadowBlur = 40;
        ctx.shadowColor = "#8b0000";
        ctx.beginPath();
        ctx.arc(moonX, moonY, 40 + pulse, 0, Math.PI * 2);
        ctx.fill();
        
        // Moon main body
        ctx.fillStyle = "rgba(139, 0, 0, 0.9)";
        ctx.shadowBlur = 25;
        ctx.shadowColor = "#ff0000";
        ctx.beginPath();
        ctx.arc(moonX, moonY, 25 + pulse * 0.5, 0, Math.PI * 2);
        ctx.fill();
        
        // Moon craters for texture
        ctx.fillStyle = "rgba(100, 0, 0, 0.6)";
        ctx.shadowBlur = 0;
        ctx.beginPath();
        ctx.arc(moonX - 8, moonY - 5, 5, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(moonX + 10, moonY + 8, 4, 0, Math.PI * 2);
        ctx.fill();
        
        // Stars in the background
        ctx.fillStyle = "rgba(255, 255, 255, 0.3)";
        for (let i = 0; i < 20; i++) {
          const starX = (i * 37 + frames * 0.1) % canvas.width;
          const starY = (i * 23) % 300;
          const twinkle = Math.sin(frames * 0.1 + i) * 0.5 + 0.5;
          ctx.globalAlpha = twinkle * 0.5;
          ctx.beginPath();
          ctx.arc(starX, starY, 1, 0, Math.PI * 2);
          ctx.fill();
        }
        ctx.globalAlpha = 1;
        
        // Enhanced fog with multiple layers
        for (let layer = 0; layer < 3; layer++) {
          ctx.fillStyle = `rgba(50, 0, 0, ${0.15 - layer * 0.05})`;
          for (let i = 0; i < 8; i++) {
            const fogX = (frames * (0.3 + layer * 0.2) + i * 50) % (canvas.width + 60) - 30;
            const fogY = 150 + layer * 100 + Math.sin(frames * 0.01 + i + layer) * 40;
            const fogSize = 40 + Math.sin(frames * 0.02 + i + layer) * 15;
            ctx.beginPath();
            ctx.arc(fogX, fogY, fogSize, 0, Math.PI * 2);
            ctx.fill();
          }
        }
        
        // Floating particles (souls/spirits)
        ctx.fillStyle = "rgba(255, 0, 0, 0.3)";
        ctx.shadowBlur = 10;
        ctx.shadowColor = "#ff0000";
        for (let i = 0; i < 5; i++) {
          const particleX = (frames * 0.2 + i * 80) % (canvas.width + 20) - 10;
          const particleY = 100 + Math.sin(frames * 0.03 + i) * 80;
          ctx.beginPath();
          ctx.arc(particleX, particleY, 3, 0, Math.PI * 2);
          ctx.fill();
        }
        ctx.shadowBlur = 0;
      }

      function createPipe() {
        const minTop = 80;  // More space at top
        const maxTop = 320;  // More space at bottom
        const top = Math.random() * (maxTop - minTop) + minTop;

        pipes.push({
          x: canvas.width,
          top: top,
          bottom: top + pipeGap,
          scored: false,
        });
      }

      function updateBird() {
        bird.velocity += bird.gravity;
        bird.y += bird.velocity;

        bird.rotation = Math.min(Math.max(bird.velocity * 0.05, -0.5), 0.5);

        if (bird.y + bird.height > 450) {
          gameOver();
        }
        if (bird.y < 0) {
          bird.y = 0;
          bird.velocity = 0;
        }
      }

      function updatePipes() {
        if (frames % 120 === 0) {  // Obstacles appear less frequently
          createPipe();
        }

        for (let i = pipes.length - 1; i >= 0; i--) {
          pipes[i].x -= pipeSpeed;

          if (!pipes[i].scored && pipes[i].x + pipeWidth < bird.x) {
            score++;
            pipes[i].scored = true;
            document.getElementById("score").textContent = score;
            document.getElementById("score").style.textShadow = `0 0 ${10 + score}px #ff0000, 0 0 ${20 + score}px #ff0000`;
            playScoreSound();
          }

          if (pipes[i].x + pipeWidth < 0) {
            pipes.splice(i, 1);
          }

          if (checkCollision(pipes[i])) {
            gameOver();
          }
        }
      }

      function checkCollision(pipe) {
        if (bird.x + bird.width > pipe.x && bird.x < pipe.x + pipeWidth) {
          if (bird.y < pipe.top || bird.y + bird.height > pipe.bottom) {
            return true;
          }
        }
        return false;
      }

      function gameLoop() {
        if (gameState !== "playing") return;

        drawBackground();

        pipes.forEach((pipe) => drawPipe(pipe));
        updatePipes();

        updateBird();
        drawBird();

        frames++;
        requestAnimationFrame(gameLoop);
      }

      function startGame() {
        gameState = "playing";
        score = 0;
        frames = 0;
        bird.y = 250;
        bird.velocity = 0;
        pipes.length = 0;

        document.getElementById("startScreen").classList.add("hidden");
        document.getElementById("gameOverScreen").classList.add("hidden");
        document.getElementById("score").classList.remove("hidden");
        document.getElementById("score").textContent = "0";

        gameLoop();
      }

      function restartGame() {
        startGame();
      }

      function gameOver() {
        gameState = "gameOver";
        document.getElementById("finalScore").textContent = `Score: ${score}`;
        document.getElementById("gameOverScreen").classList.remove("hidden");
        playGameOverSound();
      }

      function flap() {
        if (gameState === "playing") {
          bird.velocity = bird.jump;
          playFlapSound();
        }
      }

      document.addEventListener("keydown", (e) => {
        if (e.code === "Space") {
          e.preventDefault();
          flap();
        }
      });

      canvas.addEventListener("click", flap);

      drawBackground();
      drawBird();
    </script>
  </body>
</html>
